<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"czhen-zilliz.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Tech Sharing">
<meta property="og:type" content="website">
<meta property="og:title" content="Blog - czhen-zilliz">
<meta property="og:url" content="https://czhen-zilliz.github.io/index.html">
<meta property="og:site_name" content="Blog - czhen-zilliz">
<meta property="og:description" content="Tech Sharing">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="czhen">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://czhen-zilliz.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Blog - czhen-zilliz</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Blog - czhen-zilliz</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Tech Sharing</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://czhen-zilliz.github.io/2021/12/06/texlive/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="czhen">
      <meta itemprop="description" content="Tech Sharing">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog - czhen-zilliz">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/06/texlive/" class="post-title-link" itemprop="url">Using pandoc to build pdf with toc in github action</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-12-06 11:57:53 / Modified: 00:00:00" itemprop="dateCreated datePublished" datetime="2021-12-06T11:57:53+08:00">2021-12-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Using-pandoc-to-build-pdf-with-toc-in-github-action"><a href="#Using-pandoc-to-build-pdf-with-toc-in-github-action" class="headerlink" title="Using pandoc to build pdf with toc in github action"></a>Using pandoc to build pdf with toc in github action</h1><p>[toc]</p>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>This doc is written based on below listed version, any updates please refer to offical doc.<br>pandoc 2.16.2 (2021-11-21).<br>tlmgr revision 60693 (2021-10-04).<br>fnm 1.28.1 installed with node v17.2.0.</p>
<p>sample project: <a target="_blank" rel="noopener" href="https://github.com/zilliztech/docs.zilliz.com">https://github.com/zilliztech/docs.zilliz.com</a><br>sample docker: <a target="_blank" rel="noopener" href="https://hub.docker.com/repository/docker/xiaohongczh/xelatex">https://hub.docker.com/repository/docker/xiaohongczh/xelatex</a></p>
<h2 id="Prepare-source-content"><a href="#Prepare-source-content" class="headerlink" title="Prepare source content"></a>Prepare source content</h2><p>Pandoc supports various format doc transformation. (see <a target="_blank" rel="noopener" href="https://pandoc.org/index.html">https://pandoc.org/index.html</a>). It extract doc title as toc entry. Like #, ##, ###… in markdown or h1, h2, h3…in html. Before we generate pdf, we have to reformat doc with proper doc title so that the pdf toc will meet our requirement.<br>Or<br>Another way is to use latex syntax to build a toc template and import this template while pandoc building process. We would not discussion latex syntax here.</p>
<h2 id="Build-docker"><a href="#Build-docker" class="headerlink" title="Build docker"></a>Build docker</h2><p>To run pandoc in github action, a docker image is required. We may need different packages to build pdf. Offical image may need extra installation. So we build a customized image on ourselves. </p>
<h3 id="Start-a-base-ubuntu-image"><a href="#Start-a-base-ubuntu-image" class="headerlink" title="Start a base ubuntu image"></a>Start a base ubuntu image</h3><p>Start a minized Ubuntu image:<br><code>docker run -it -v ~/Documents/docker_vol_01:/docker_vol_01 ubuntu bash</code></p>
<h3 id="Install-pandoc"><a href="#Install-pandoc" class="headerlink" title="Install pandoc"></a>Install pandoc</h3><p>Download deb package from <a target="_blank" rel="noopener" href="https://github.com/jgm/pandoc/releases/">github</a></p>
<h3 id="Install-texlive"><a href="#Install-texlive" class="headerlink" title="Install texlive"></a>Install texlive</h3><p>Since we need to use xelatex as pdf build engine (default pdf engine is pdflatex which does not support some unicode like Chinese character or emoji well), texlive is a must to be installed.</p>
<p>Here is <a target="_blank" rel="noopener" href="https://tug.org/texlive/acquire.html">some ways</a> of installing texlive</p>
<p>The <a target="_blank" rel="noopener" href="https://tug.org/texlive/acquire-mirror.html">Mirroring/downloading the TeX Live repository</a> is the most stable and the only way that I succeeded.</p>
<p>Chose proper <a target="_blank" rel="noopener" href="https://ctan.org/mirrors">site</a><br>and<br>rsync -a –delete rsync://somectan/somepath/systems/texlive/tlnet/ /your/local/dir/<br>or<br>wget –mirror –no-parent <a href="ftp://somectan/somepath/systems/texlive/tlnet/">ftp://somectan/somepath/systems/texlive/tlnet/</a> /your/local/dir</p>
<p><em>This step might take dozens of hours, so be prepared in advanced.</em></p>
<h3 id="Remove-useless-code"><a href="#Remove-useless-code" class="headerlink" title="Remove useless code"></a>Remove useless code</h3><ol>
<li>Get into <code>/usr/local/texlive/2021</code></li>
<li>Run <code>du -sh ./*</code> <code>doc</code> folder is around 4GB.</li>
<li>Remove <code>doc</code> folder</li>
</ol>
<h3 id="Install-nodejs-optional"><a href="#Install-nodejs-optional" class="headerlink" title="Install nodejs (optional)"></a>Install nodejs (optional)</h3><p>We need script runtime to excute jobs. We chose nodejs to run jobs and fnm to install node.</p>
<p>You can pick any language you prefered and install them on this image.</p>
<h3 id="Config-env-variables"><a href="#Config-env-variables" class="headerlink" title="Config env variables"></a>Config env variables</h3><p>Check .bashrc ro .bash_profile if PATH is proplerly configured.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> texlive</span></span><br><span class="line">export PATH=/usr/local/texlive/2021/bin/x86_64-linux:$PATH</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> fnm</span></span><br><span class="line">export PATH=/root/.fnm:$PATH</span><br><span class="line">eval &quot;$(fnm env)&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Check-every-thing-is-ready"><a href="#Check-every-thing-is-ready" class="headerlink" title="Check every thing is ready"></a>Check every thing is ready</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pandoc -v</span><br><span class="line">tlmgr --version</span><br><span class="line">fnm list</span><br><span class="line">node -v</span><br></pre></td></tr></table></figure>

<h3 id="Sample-pandoc-script-to-generate-pdf"><a href="#Sample-pandoc-script-to-generate-pdf" class="headerlink" title="Sample pandoc script to generate pdf"></a>Sample pandoc script to generate pdf</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pandoc --toc --toc-depth=2 --verbose -s  --resource-path=src -f markdown+link_attributses -V geometry:&quot;left=2cm, top=2cm, right=2cm, bottom=2cm&quot; -V title=&quot;Test PDF&quot; -V mainfont=&quot;Symbola&quot; -V CJKmainfont=&quot;AR PL SungtiL GB&quot;  --pdf-engine=xelatex -o  test_cn.pdf src/test.md</span><br></pre></td></tr></table></figure>

<p>Important arguments:</p>
<ul>
<li><code>--toc</code> means generate pdf with toc</li>
<li><code>--toc-depth=2</code> means extrac only top 2 level title as toc (h1 and h2 or # and ##)</li>
<li><code>--verbose</code> print all logs while generate</li>
<li><code>--resource-path</code> the the relative path for build pdf. If you have some relateive linked asset or resources like image in source file, add the argument.</li>
<li><code>-V</code> add some extra argument like:<ul>
<li><code>geometry</code> actuall size of pdf file</li>
<li><code>title</code> pdf title</li>
<li><code>mainfont</code> main font for pdf</li>
<li><code>CJKmainfont</code> main font for CJK characters in pdf</li>
</ul>
</li>
<li><code>--pdf-engine</code> pdf generate engine</li>
<li><code>-o</code> output file path and file name</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://czhen-zilliz.github.io/2021/12/06/zilliverse/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="czhen">
      <meta itemprop="description" content="Tech Sharing">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog - czhen-zilliz">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/06/zilliverse/" class="post-title-link" itemprop="url">Implement Universe by Three.js</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-06 11:57:53" itemprop="dateCreated datePublished" datetime="2021-12-06T11:57:53+08:00">2021-12-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-09-08 00:00:00" itemprop="dateModified" datetime="2021-09-08T00:00:00+08:00">2021-09-08</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Implement-Universe-by-Three-js"><a href="#Implement-Universe-by-Three-js" class="headerlink" title="Implement Universe by Three.js"></a>Implement Universe by Three.js</h1><p>[TOC]</p>
<h2 id="How-does-the-universe-look-like"><a href="#How-does-the-universe-look-like" class="headerlink" title="How does the universe look like?"></a>How does the universe look like?</h2><p><img src="https://user-images.githubusercontent.com/83751452/127113680-d5f77906-68f3-40f4-ac67-994234fb9c03.gif" alt="zilliverse"></p>
<p>Here’s the link: <a target="_blank" rel="noopener" href="https://zilliz.com/universe">https://zilliz.com/universe</a></p>
<p>We want to build a hero universe. This universe should have different stars as heroes. After specifiec duration the camera will randomly focus on one star and the info will appear. Each group of stars revolve around a “Zilliz” star and will appear or disappear periodically, just like blink.</p>
<h2 id="How-to-implement-universe"><a href="#How-to-implement-universe" class="headerlink" title="How to implement universe?"></a>How to implement universe?</h2><p>Three.js Docs: <a target="_blank" rel="noopener" href="https://threejs.org/docs/index.html#manual/en/introduction/Creating-a-scene">https://threejs.org/docs/index.html#manual/en/introduction/Creating-a-scene</a></p>
<h3 id="Brief-introduction"><a href="#Brief-introduction" class="headerlink" title="Brief introduction"></a>Brief introduction</h3><p>Creating the scene =&gt; Rendering the scene =&gt; Animating the elements</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">renderUniverse</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Define variables &amp; scene here.</span></span><br><span class="line">  init();</span><br><span class="line">  animate();</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Init scene (including elements) here.</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">animate</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    requestAnimationFrame(animate);</span><br><span class="line">    render();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Define how elements change in scene.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="Creating-the-scene"><a href="#Creating-the-scene" class="headerlink" title="Creating the scene"></a>Creating the scene</h3><blockquote>
<p>To actually be able to display anything with three.js, we need three things: scene, camera and renderer, so that we can render the scene with camera.</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// functuin init() &#123;</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> camera, scene, renderer;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Init scene.</span></span><br><span class="line">scene = <span class="keyword">new</span> THREE.Scene();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Init camera.</span></span><br><span class="line">camera = <span class="keyword">new</span> THREE.PerspectiveCamera(</span><br><span class="line">  <span class="number">25</span>,</span><br><span class="line">  SCREEN_WIDTH / SCREEN_HEIGHT,</span><br><span class="line">  <span class="number">50</span>,</span><br><span class="line">  <span class="number">1e7</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Init renderer.</span></span><br><span class="line">renderer = <span class="keyword">new</span> THREE.WebGLRenderer(&#123; <span class="attr">antialias</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Then mount the renderer.</span></span><br><span class="line"><span class="built_in">document</span>.body.appendChild(renderer.domElement);</span><br></pre></td></tr></table></figure>

<h4 id="Add-elements-to-this-scene"><a href="#Add-elements-to-this-scene" class="headerlink" title="Add elements to this scene"></a>Add elements to this scene</h4><ol>
<li>Scene Background: <code>scene.background = new THREE.Color(0x010e29);</code></li>
<li>Scene Fog: <code>scene.fog = new THREE.FogExp2(0x000000, 0.00000025);</code></li>
<li>Direct Light: </li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dirLight = <span class="keyword">new</span> THREE.DirectionalLight(<span class="number">0xffffff</span>);</span><br><span class="line">dirLight.position.set(<span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>).normalize();</span><br><span class="line">scene.add(dirLight);</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Geometry: (There’re different geometries and we use <code>SphereGeometry</code> here):</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> material = <span class="keyword">new</span> THREE.MeshPhongMaterial(&#123;</span><br><span class="line">  <span class="attr">specular</span>: <span class="number">0x333333</span>,</span><br><span class="line">  <span class="attr">shininess</span>: <span class="number">15</span>,</span><br><span class="line">  <span class="attr">map</span>: textureLoader.load(<span class="string">&#x27;/images/starLogo.svg&#x27;</span>),</span><br><span class="line">  <span class="attr">normalScale</span>: <span class="keyword">new</span> THREE.Vector2(<span class="number">0.85</span>, -<span class="number">0.85</span>),</span><br><span class="line">  <span class="attr">transparent</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> geometry = <span class="keyword">new</span> THREE.SphereGeometry(</span><br><span class="line">  radius,</span><br><span class="line">  <span class="number">32</span>,</span><br><span class="line">  <span class="number">32</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">const</span> meshPlanet = <span class="keyword">new</span> THREE.Mesh(geometry, material);</span><br><span class="line">scene.add(meshPlanet);</span><br></pre></td></tr></table></figure>

<h4 id="Tandem-addition"><a href="#Tandem-addition" class="headerlink" title="Tandem addition"></a>Tandem addition</h4><p>As the code above, we define a scene, and add background, fog, light and geometry to it. But universe has galaxy such as solar system, a star has many planets revolving around it, a planet has many moons… So we can add a <code>meshPlanet</code> to a <code>meshPlanet</code>, just like tandem addition.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// functuin init() &#123;</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> earthMaterial = <span class="keyword">new</span> THREE.MeshPhongMaterial(&#123;</span><br><span class="line">  <span class="comment">// emissive: 0x7dcef4,</span></span><br><span class="line">  <span class="attr">map</span>: textureLoader.load(</span><br><span class="line">    <span class="string">`textures/planets/earth.jpg`</span></span><br><span class="line">  ),</span><br><span class="line">  <span class="attr">transparent</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">opacity</span>: <span class="number">1</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> meshMoon = <span class="keyword">new</span> THREE.Mesh(geometry, earthMaterial);</span><br><span class="line"><span class="keyword">const</span> rand = <span class="built_in">Math</span>.random();</span><br><span class="line"><span class="keyword">const</span> moonRadian = <span class="built_in">Math</span>.PI * <span class="number">2</span> * rand;</span><br><span class="line">meshMoon.position.set(</span><br><span class="line">  moonRadius * <span class="built_in">Math</span>.sin(moonRadian),</span><br><span class="line">  <span class="number">0</span>,</span><br><span class="line">  moonRadius * <span class="built_in">Math</span>.cos(moonRadian)</span><br><span class="line">);</span><br><span class="line">meshMoon.scale.set(</span><br><span class="line">  moonScale * rand,</span><br><span class="line">  moonScale * rand,</span><br><span class="line">  moonScale * rand</span><br><span class="line">);</span><br><span class="line">meshMoon.resetScale = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> size = moonScale * rand * <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">this</span>.scale.set(size, size, size);</span><br><span class="line">&#125;;</span><br><span class="line">meshPlanet.add(meshMoon);</span><br></pre></td></tr></table></figure>

<p>Then we have a meshPlanet with a meshMoon, we can add more different meshMoon here and it will look more real.</p>
<p>After tandem addition, if you change the meshPlanet’s position or rotate it, all children will change with it, so that we can make a moving galaxy.</p>
<h3 id="Customize-Scene"><a href="#Customize-Scene" class="headerlink" title="Customize Scene"></a>Customize Scene</h3><h4 id="Define-different-tracks"><a href="#Define-different-tracks" class="headerlink" title="Define different tracks"></a>Define different tracks</h4><p>If we have three transparent planets in the same position, each planet has a number of moons with different tilt angles, directions and radius, it will look more vivid.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Here&#x27;s the example of defination, the changes need to be set up in render().</span></span><br><span class="line"><span class="comment">// functuin init() &#123;</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> meshPlanets = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  <span class="keyword">const</span> emptyMaterialNormalMap = <span class="keyword">new</span> THREE.MeshPhongMaterial(&#123;</span><br><span class="line">    <span class="attr">transparent</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">opacity</span>: <span class="number">0</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> tempMeshPlanet = <span class="keyword">new</span> THREE.Mesh(</span><br><span class="line">    meshPlanetGeometry,</span><br><span class="line">    emptyMaterialNormalMap</span><br><span class="line">  );</span><br><span class="line">  meshPlanets.push(tempMeshPlanet);</span><br><span class="line">  scene.add(tempMeshPlanet);</span><br><span class="line">&#125;</span><br><span class="line">meshPlanets.forEach(<span class="function"><span class="params">planet</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> tempMoonsCollection = [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> rand = <span class="built_in">Math</span>.random();</span><br><span class="line">    <span class="keyword">const</span> rand1 = <span class="built_in">Math</span>.random();</span><br><span class="line">    <span class="keyword">const</span> moonRadius = radius * <span class="number">5</span> * rand;</span><br><span class="line">    <span class="keyword">const</span> moonRadian = <span class="built_in">Math</span>.PI * <span class="number">2</span> * rand1;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> randomPlanetMaterial = <span class="keyword">new</span> THREE.MeshPhongMaterial(&#123;</span><br><span class="line">      <span class="attr">emissive</span>: <span class="number">0x7dcef4</span>,</span><br><span class="line">      <span class="attr">transparent</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">opacity</span>: <span class="number">1</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    meshMoon1 = <span class="keyword">new</span> THREE.Mesh(geometry, randomPlanetMaterial);</span><br><span class="line">    meshMoon1.position.set(</span><br><span class="line">      moonRadius * <span class="built_in">Math</span>.sin(moonRadian),</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      moonRadius * <span class="built_in">Math</span>.cos(moonRadian)</span><br><span class="line">    );</span><br><span class="line">    meshMoon1.scale.set(</span><br><span class="line">      moonScale * rand,</span><br><span class="line">      moonScale * rand,</span><br><span class="line">      moonScale * rand</span><br><span class="line">    );</span><br><span class="line">    meshMoon1.resetScale = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> size = moonScale * rand * <span class="number">2</span>;</span><br><span class="line">      <span class="built_in">this</span>.scale.set(size, size, size);</span><br><span class="line">    &#125;;</span><br><span class="line">    tempMoonsCollection.push(meshMoon1);</span><br><span class="line">    moons.push(meshMoon1);</span><br><span class="line">  &#125;</span><br><span class="line">  moonsCollection.push(tempMoonsCollection);</span><br><span class="line"></span><br><span class="line">  planet.rotation.x -= <span class="built_in">Math</span>.random();</span><br><span class="line">  planet.rotation.z += <span class="number">0.3</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="Define-background-with-little-stars"><a href="#Define-background-with-little-stars" class="headerlink" title="Define background with little stars"></a>Define background with little stars</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// functuin init() &#123;</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> starsGeometry = <span class="keyword">new</span> THREE.BufferGeometry();</span><br><span class="line"><span class="keyword">const</span> vertex = <span class="keyword">new</span> THREE.Vector3();</span><br><span class="line"><span class="keyword">const</span> vertices = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">250</span>; i++) &#123;</span><br><span class="line">  vertex.x = <span class="built_in">Math</span>.random() * <span class="number">2</span> - <span class="number">1</span>;</span><br><span class="line">  vertex.y = <span class="built_in">Math</span>.random() * <span class="number">2</span> - <span class="number">1</span>;</span><br><span class="line">  vertex.z = <span class="built_in">Math</span>.random() * <span class="number">2</span> - <span class="number">1</span>;</span><br><span class="line">  vertex.multiplyScalar(r);</span><br><span class="line"></span><br><span class="line">  vertices.push(vertex.x, vertex.y, vertex.z);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">starsGeometry.setAttribute(</span><br><span class="line">  <span class="string">&#x27;position&#x27;</span>,</span><br><span class="line">  <span class="keyword">new</span> THREE.Float32BufferAttribute(vertices, <span class="number">3</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> starsMaterials = <span class="keyword">new</span> THREE.PointsMaterial(&#123;</span><br><span class="line">  <span class="attr">color</span>: <span class="number">0x555555</span>,</span><br><span class="line">  <span class="attr">size</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">sizeAttenuation</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">10</span>; i &lt; <span class="number">300</span>; i++) &#123;</span><br><span class="line">  <span class="keyword">const</span> stars = <span class="keyword">new</span> THREE.Points(</span><br><span class="line">    starsGeometry,</span><br><span class="line">    starsMaterials</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  stars.rotation.x = <span class="built_in">Math</span>.random() * <span class="number">6</span>;</span><br><span class="line">  stars.rotation.y = <span class="built_in">Math</span>.random() * <span class="number">6</span>;</span><br><span class="line">  stars.rotation.z = <span class="built_in">Math</span>.random() * <span class="number">6</span>;</span><br><span class="line">  stars.scale.setScalar(i * <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  stars.matrixAutoUpdate = <span class="literal">false</span>;</span><br><span class="line">  stars.updateMatrix();</span><br><span class="line"></span><br><span class="line">  scene.add(stars);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Customize-rendering"><a href="#Customize-rendering" class="headerlink" title="Customize rendering"></a>Customize rendering</h3><h4 id="Make-moons-rotating"><a href="#Make-moons-rotating" class="headerlink" title="Make moons rotating"></a>Make moons rotating</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> clock = <span class="keyword">new</span> THREE.Clock();</span><br><span class="line"></span><br><span class="line"><span class="comment">// function render() &#123;</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rotationSpeed = <span class="number">0.025</span>;</span><br><span class="line"><span class="keyword">const</span> delta = clock.getDelta();</span><br><span class="line"></span><br><span class="line">meshPlanet.rotation.y -= rotationSpeed * <span class="number">15</span> * delta;</span><br><span class="line"></span><br><span class="line">meshPlanets.forEach(</span><br><span class="line">  <span class="function">(<span class="params">planet, index</span>) =&gt;</span></span><br><span class="line">    (planet.rotation.y -= rotationSpeed * (index * <span class="number">2</span> + <span class="number">3</span>) * <span class="number">0.25</span> * delta)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="Make-moons-blinking"><a href="#Make-moons-blinking" class="headerlink" title="Make moons blinking"></a>Make moons blinking</h4><p>Randomly choose a set of moons(added to the same planet before)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> STATIC_BLINK_FRAMES = <span class="number">128</span>;</span><br><span class="line"><span class="keyword">let</span> blinkFrames = STATIC_BLINK_FRAMES;</span><br><span class="line"><span class="keyword">let</span> shouldAddOpacity = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> blinkList = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">// function render() &#123;</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Raise opacity and the star will be brighter.</span></span><br><span class="line"><span class="keyword">if</span> (shouldAddOpacity) &#123;</span><br><span class="line">  blinkList.forEach(</span><br><span class="line">    <span class="function"><span class="params">targetMoon</span> =&gt;</span> (targetMoon.material.opacity += <span class="number">1</span> / STATIC_BLINK_FRAMES)</span><br><span class="line">  );</span><br><span class="line">  blinkFrames++;</span><br><span class="line"><span class="comment">// Reduce opacity and the star will be darker.</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  blinkList.forEach(</span><br><span class="line">    <span class="function"><span class="params">targetMoon</span> =&gt;</span> (targetMoon.material.opacity -= <span class="number">1</span> / STATIC_BLINK_FRAMES)</span><br><span class="line">  );</span><br><span class="line">  blinkFrames--;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (blinkFrames &lt;= -STATIC_BLINK_FRAMES) &#123;</span><br><span class="line">  shouldAddOpacity = <span class="literal">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (blinkFrames &gt; STATIC_BLINK_FRAMES * <span class="number">2</span>) &#123;</span><br><span class="line">  shouldAddOpacity = <span class="literal">false</span>;</span><br><span class="line">  blinkList.forEach(<span class="function"><span class="params">targetMoon</span> =&gt;</span> (targetMoon.material.opacity = <span class="number">1</span>));</span><br><span class="line">  blinkFrames = STATIC_BLINK_FRAMES;</span><br><span class="line">  blinkList = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Let-camera-moves-more-smoothly"><a href="#Let-camera-moves-more-smoothly" class="headerlink" title="Let camera moves more smoothly"></a>Let camera moves more smoothly</h4><p>If we need move camera from position A to B, we can divide the process into a number of pieces, and camera only complete one piece movement in one frame. Smaller the piece is, more smoothly.</p>
<p>Besides, we need to change the camera angle to fit the movement, so we can divide the process as same as above.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">lookAtObj</span>(<span class="params">camera, object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> boundingBox = <span class="keyword">new</span> THREE.Box3();</span><br><span class="line">  boundingBox.setFromObject(object);</span><br><span class="line">  <span class="keyword">const</span> center = boundingBox.getCenter(<span class="keyword">new</span> THREE.Vector3());</span><br><span class="line">  camera.lookAt(center);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> movingCamera = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> camCurrnetStep = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> camSpeed = <span class="number">128</span>; <span class="comment">// One movement process will be divided into 128 pieces.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// function render() &#123;</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateCamPosition</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (camCurrnetStep &gt;= camSpeed) &#123;</span><br><span class="line">    movingCamera = <span class="literal">false</span>;</span><br><span class="line">    camCurrnetStep = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  camera.position.set(</span><br><span class="line">    camera.position.x + camStepFov[<span class="number">0</span>],</span><br><span class="line">    camera.position.y + camStepFov[<span class="number">1</span>],</span><br><span class="line">    camera.position.z + camStepFov[<span class="number">2</span>]</span><br><span class="line">  );</span><br><span class="line">  targetObj &amp;&amp; lookAtObj(camera, targetObj);</span><br><span class="line">  camCurrnetStep++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">movingCamera &amp;&amp; updateCamPosition();</span><br></pre></td></tr></table></figure>

<h4 id="Add-glow-to-target-moon"><a href="#Add-glow-to-target-moon" class="headerlink" title="Add glow to target moon"></a>Add glow to target moon</h4><p>We want to add glow to each star when focused, and the glow should smoothly appear and disappear. So that the user can obviously and easily find the target star.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// function init() &#123;</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">const</span> glowMaterial = <span class="keyword">new</span> THREE.ShaderMaterial(&#123;</span><br><span class="line">  <span class="attr">uniforms</span>: &#123;</span><br><span class="line">    <span class="attr">c</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;f&#x27;</span>, <span class="attr">value</span>: <span class="number">0.2</span> &#125;,</span><br><span class="line">    <span class="attr">p</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;f&#x27;</span>, <span class="attr">value</span>: <span class="number">1.0</span> &#125;,</span><br><span class="line">    <span class="attr">glowColor</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;c&#x27;</span>, <span class="attr">value</span>: <span class="keyword">new</span> THREE.Color(<span class="number">0x06aff2</span>) &#125;,</span><br><span class="line">    <span class="attr">viewVector</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;v3&#x27;</span>, <span class="attr">value</span>: camera.position &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// Shader</span></span><br><span class="line">  <span class="attr">vertexShader</span>: <span class="string">`uniform vec3 viewVector;</span></span><br><span class="line"><span class="string">    uniform float c;</span></span><br><span class="line"><span class="string">    uniform float p;</span></span><br><span class="line"><span class="string">    varying float intensity;</span></span><br><span class="line"><span class="string">    void main() </span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      vec3 vNormal = normalize( normalMatrix * normal );</span></span><br><span class="line"><span class="string">      vec3 vNormel = normalize( normalMatrix * viewVector );</span></span><br><span class="line"><span class="string">      intensity = pow( c - dot(vNormal, vNormel), p );</span></span><br><span class="line"><span class="string">      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );</span></span><br><span class="line"><span class="string">    &#125;`</span>,</span><br><span class="line">  <span class="attr">fragmentShader</span>: <span class="string">`uniform vec3 glowColor;</span></span><br><span class="line"><span class="string">    varying float intensity;</span></span><br><span class="line"><span class="string">    void main() </span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      vec3 glow = glowColor * intensity;</span></span><br><span class="line"><span class="string">      gl_FragColor = vec4( glow, 1.0 );</span></span><br><span class="line"><span class="string">    &#125;`</span>,</span><br><span class="line">  <span class="attr">side</span>: THREE.BackSide,</span><br><span class="line">  <span class="attr">blending</span>: THREE.AdditiveBlending,</span><br><span class="line">  <span class="attr">transparent</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> moonGlow = <span class="keyword">new</span> THREE.Mesh(geometry, glowMaterial);</span><br><span class="line">moonGlow.position.set(...);</span><br><span class="line">moonGlow.scale.set(...);</span><br><span class="line">meshMoon.targetGlow = moonGlow; <span class="comment">// Add the glow to moon&#x27;s property here will make it easier for us to change it.</span></span><br><span class="line">planet.add(meshMoon);</span><br></pre></td></tr></table></figure>



<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> shouldAddGlow = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// function render() &#123;</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateTargetGlow</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> glowStep = <span class="number">0.005</span>;</span><br><span class="line">  <span class="keyword">if</span> (!targetGlow) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (shouldAddGlow) &#123;</span><br><span class="line">    targetGlow.material.uniforms.c.value += glowStep;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    targetGlow.material.uniforms.c.value -= glowStep;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (targetGlow.material.uniforms.c.value &gt;= <span class="number">0.3</span>) &#123;</span><br><span class="line">    shouldAddGlow = <span class="literal">false</span>;</span><br><span class="line">    targetGlow.material.uniforms.c.value = <span class="number">0.3</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (targetGlow.material.uniforms.c.value &lt;= <span class="number">0.1</span>) &#123;</span><br><span class="line">    shouldAddGlow = <span class="literal">true</span>;</span><br><span class="line">    targetGlow.material.uniforms.c.value = <span class="number">0.1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// targetGlow.material.uniforms.c.value = nextUniformsC;</span></span><br><span class="line">  <span class="comment">// targetGlow.updateMatrix();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">updateTargetGlow();</span><br></pre></td></tr></table></figure>

<h4 id="Resize-automatically"><a href="#Resize-automatically" class="headerlink" title="Resize automatically"></a>Resize automatically</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">&#x27;resize&#x27;</span>, onWindowResize);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onWindowResize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  SCREEN_WIDTH = <span class="built_in">document</span>.body.clientWidth - MARGIN * <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">if</span> (SCREEN_WIDTH &lt;= <span class="number">488</span>) &#123;</span><br><span class="line">    SCREEN_HEIGHT = (SCREEN_WIDTH * <span class="number">4</span>) / <span class="number">3</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    SCREEN_HEIGHT = (SCREEN_WIDTH * <span class="number">9</span>) / <span class="number">21</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  camera.aspect = SCREEN_WIDTH / SCREEN_HEIGHT;</span><br><span class="line">  camera.updateProjectionMatrix();</span><br><span class="line"></span><br><span class="line">  renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);</span><br><span class="line">  composer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://czhen-zilliz.github.io/2021/12/06/milvus_cli/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="czhen">
      <meta itemprop="description" content="Tech Sharing">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog - czhen-zilliz">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/06/milvus_cli/" class="post-title-link" itemprop="url">Implement Milvus CLI by Python Click</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-06 11:57:53" itemprop="dateCreated datePublished" datetime="2021-12-06T11:57:53+08:00">2021-12-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Implement-Milvus-CLI-by-Python-Click"><a href="#Implement-Milvus-CLI-by-Python-Click" class="headerlink" title="Implement Milvus CLI by Python Click"></a>Implement Milvus CLI by Python Click</h1><p>[toc]</p>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>Project URL: <a target="_blank" rel="noopener" href="https://github.com/milvus-io/milvus_cli">https://github.com/milvus-io/milvus_cli</a></p>
<p>Preparation: <code>Python3.8</code>,<a target="_blank" rel="noopener" href="https://click.palletsprojects.com/en/8.0.x/api/"> <code>Click 8.0.x</code></a> </p>
<h2 id="Group-commands"><a href="#Group-commands" class="headerlink" title="Group commands"></a>Group commands</h2><h3 id="Create-a-command"><a href="#Create-a-command" class="headerlink" title="Create a command"></a>Create a command</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> click</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> PyOrm</span><br><span class="line"></span><br><span class="line"><span class="meta">@click.group(<span class="params">no_args_is_help=<span class="literal">False</span>, add_help_option=<span class="literal">False</span>, invoke_without_command=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="meta">@click.pass_context</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cli</span>(<span class="params">ctx</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Milvus CLI&quot;&quot;&quot;</span></span><br><span class="line">    ctx.obj = PyOrm() <span class="comment"># PyOrm is a util class which wraps the milvus python SDK. You can pass any class instance here. Any command function passed @click.obj can call it.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    cli()</span><br></pre></td></tr></table></figure>

<p>As the code above, we use <code>@click.group()</code> to create a command group <code>cli</code> as entry point. To implement a prompt CLI we need to disable help messages for the entry, so we add <code>no_args_is_help=False</code>, <code>add_help_option=False</code> and <code>invoke_without_command=True</code>. And nothing will be printed if we input <code>cli</code> in terminal only.</p>
<p>Besides we use <code>@click.pass_context</code> to pass a context to this group for further usage.</p>
<h3 id="Create-a-sub-command-of-command-group"><a href="#Create-a-sub-command-of-command-group" class="headerlink" title="Create a sub command of command group"></a>Create a sub command of command group</h3><p>Then we add the first sub command <code>help</code> under <code>cli</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Print the help message of specified command.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_help_msg</span>(<span class="params">command</span>):</span></span><br><span class="line">    <span class="keyword">with</span> click.Context(command) <span class="keyword">as</span> ctx:</span><br><span class="line">        click.echo(command.get_help(ctx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use @cli.command() to create a sub command of cli.</span></span><br><span class="line"><span class="meta">@cli.command()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">help</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Show help messages.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Print help message of cli.</span></span><br><span class="line">    click.echo(print_help_msg(cli))</span><br></pre></td></tr></table></figure>

<p>Now we can use <code>cli help</code>  in terminal:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> python milvus_cli/scripts/milvus_cli.py <span class="built_in">help</span></span></span><br></pre></td></tr></table></figure>

<h3 id="Create-a-sub-group-of-a-command-group"><a href="#Create-a-sub-group-of-a-command-group" class="headerlink" title="Create a sub group of a command group"></a>Create a sub group of a command group</h3><p>Not only we want to have a sub command like <code>cli help</code>, but also we need a sub group commands such as <code>cli list collection</code> , <code>cli list partition</code> and <code>cli list indexes</code>.</p>
<p>First we create a sub group command <code>list</code>, here we can pass the first parameter to <code>@cli.group</code> as the command name instead of use defult function name, so that we can reduce duplicated function names.</p>
<p>Attention here, we use <code>@cli.group()</code> instead of <code>@click.group</code> so that we create a sub group of origin group.</p>
<p>The we use <code>@click.pass_obj</code> to pass the <code>context.obj</code> to sub commands of this sub group.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@cli.group(<span class="params"><span class="string">&#x27;list&#x27;</span>, no_args_is_help=<span class="literal">False</span></span>)</span></span><br><span class="line"><span class="meta">@click.pass_obj</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">listDetails</span>(<span class="params">obj</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;List collections, partitions and indexes.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>Then we add some sub commands into this sub group by <code>@listDetails.command()</code> (not <code>@cli.command()</code>). Here’s just an example, you can ignore the implement and we will discuss it later.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@listDetails.command()</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;--timeout&#x27;</span>, <span class="string">&#x27;timeout&#x27;</span>, <span class="built_in">help</span>=<span class="string">&quot;[Optional] - An optional duration of time in seconds to allow for the RPC. When timeout is set to None, client waits until server response or error occur.&quot;</span>, default=<span class="literal">None</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;--show-loaded&#x27;</span>, <span class="string">&#x27;showLoaded&#x27;</span>, <span class="built_in">help</span>=<span class="string">&quot;[Optional] - Only show loaded collections.&quot;</span>, default=<span class="literal">False</span></span>)</span></span><br><span class="line"><span class="meta">@click.pass_obj</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">collections</span>(<span class="params">obj, timeout, showLoaded</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;List all collections.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        obj.checkConnection()</span><br><span class="line">        click.echo(obj.listCollections(timeout, showLoaded))</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        click.echo(message=e, err=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@listDetails.command()</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;--collection&#x27;</span>, <span class="string">&#x27;collection&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;The name of collection.&#x27;</span>, default=<span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.pass_obj</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">partitions</span>(<span class="params">obj, collection</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;List all partitions of the specified collection.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        obj.checkConnection()</span><br><span class="line">        validateParamsByCustomFunc(</span><br><span class="line">            obj.getTargetCollection, <span class="string">&#x27;Collection Name Error!&#x27;</span>, collection)</span><br><span class="line">        click.echo(obj.listPartitions(collection))</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        click.echo(message=e, err=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>After all these complete, we have a miltigroup commands that look like:</p>
<p><img src="https://user-images.githubusercontent.com/83751452/132306467-71d81e50-3d6c-4fbe-81fc-db7280cb4838.png" alt="image"></p>
<h2 id="Custom-a-command"><a href="#Custom-a-command" class="headerlink" title="Custom a command"></a>Custom a command</h2><h3 id="Add-options"><a href="#Add-options" class="headerlink" title="Add options"></a>Add options</h3><p>You can add some options to a command which will be used like <code>cli --test-option value</code>.</p>
<p>Here’s an example, we add three options <code>alias</code>, <code>host</code> and <code>port</code> to specified an address to connect to Milvus.</p>
<p>First two parameters define the short and full option name, the third parameter defines the variable name, the <code>help</code> parameter specifies the short help message, the <code>default</code> parameter specifies the default value and the <code>type</code> specifies the value type.</p>
<p>And all options’ values will be passed into the function in order of definition.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@cli.command(<span class="params">no_args_is_help=<span class="literal">False</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-a&#x27;</span>, <span class="string">&#x27;--alias&#x27;</span>, <span class="string">&#x27;alias&#x27;</span>, <span class="built_in">help</span>=<span class="string">&quot;Milvus link alias name, default is `default`.&quot;</span>, default=<span class="string">&#x27;default&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-h&#x27;</span>, <span class="string">&#x27;--host&#x27;</span>, <span class="string">&#x27;host&#x27;</span>, <span class="built_in">help</span>=<span class="string">&quot;Host name, default is `127.0.0.1`.&quot;</span>, default=<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-p&#x27;</span>, <span class="string">&#x27;--port&#x27;</span>, <span class="string">&#x27;port&#x27;</span>, <span class="built_in">help</span>=<span class="string">&quot;Port, default is `19530`.&quot;</span>, default=<span class="number">19530</span>, <span class="built_in">type</span>=<span class="built_in">int</span></span>)</span></span><br><span class="line"><span class="meta">@click.pass_obj</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">obj, alias, host, port</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h3 id="Add-flag-options"><a href="#Add-flag-options" class="headerlink" title="Add flag options"></a>Add flag options</h3><p>We use options above to pass a value, but some times we just need a flag as a boolean value.</p>
<p>As the example below, option <code>autoId</code> is a flag option and don’t pass any data to function, so we can use it like <code>cli create collection -c c_name -p p_name -a</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@createDetails.command(<span class="params"><span class="string">&#x27;collection&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;--collection-name&#x27;</span>, <span class="string">&#x27;collectionName&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Collection name to be created.&#x27;</span>, default=<span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-p&#x27;</span>, <span class="string">&#x27;--schema-primary-field&#x27;</span>, <span class="string">&#x27;primaryField&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Primary field name.&#x27;</span>, default=<span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-a&#x27;</span>, <span class="string">&#x27;--schema-auto-id&#x27;</span>, <span class="string">&#x27;autoId&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Enable auto id.&#x27;</span>, default=<span class="literal">False</span>, is_flag=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="meta">@click.pass_obj</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">createCollection</span>(<span class="params">obj, collectionName, primaryField, autoId, description, fields</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h3 id="Add-arguments"><a href="#Add-arguments" class="headerlink" title="Add arguments"></a>Add arguments</h3><p>In this project we replace all arguments usage with options usage. But we still introduce argument usage here. Different from options, argements are used like <code>cli COMMAND [OPTIONS] ARGUEMENTS</code>. If we convert the example above into arguements usage, it’ll be like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@createDetails.command(<span class="params"><span class="string">&#x27;collection&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.argument(<span class="params"><span class="string">&#x27;collectionName&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-p&#x27;</span>, <span class="string">&#x27;--schema-primary-field&#x27;</span>, <span class="string">&#x27;primaryField&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Primary field name.&#x27;</span>, default=<span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-a&#x27;</span>, <span class="string">&#x27;--schema-auto-id&#x27;</span>, <span class="string">&#x27;autoId&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Enable auto id.&#x27;</span>, default=<span class="literal">False</span>, is_flag=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="meta">@click.pass_obj</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">createCollection</span>(<span class="params">obj, collectionName, primaryField, autoId, description, fields</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>Then the usage should be <code>cli create collection c_name -p p_name -a</code>.</p>
<h3 id="Add-full-help-message"><a href="#Add-full-help-message" class="headerlink" title="Add full help message"></a>Add full help message</h3><p>As we define the short help message above, we can define the full help message in function:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@cli.command(<span class="params">no_args_is_help=<span class="literal">False</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-a&#x27;</span>, <span class="string">&#x27;--alias&#x27;</span>, <span class="string">&#x27;alias&#x27;</span>, <span class="built_in">help</span>=<span class="string">&quot;Milvus link alias name, default is `default`.&quot;</span>, default=<span class="string">&#x27;default&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-h&#x27;</span>, <span class="string">&#x27;--host&#x27;</span>, <span class="string">&#x27;host&#x27;</span>, <span class="built_in">help</span>=<span class="string">&quot;Host name, default is `127.0.0.1`.&quot;</span>, default=<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-p&#x27;</span>, <span class="string">&#x27;--port&#x27;</span>, <span class="string">&#x27;port&#x27;</span>, <span class="built_in">help</span>=<span class="string">&quot;Port, default is `19530`.&quot;</span>, default=<span class="number">19530</span>, <span class="built_in">type</span>=<span class="built_in">int</span></span>)</span></span><br><span class="line"><span class="meta">@click.pass_obj</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">obj, alias, host, port</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Connect to Milvus.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        milvus_cli &gt; connect -h 127.0.0.1 -p 19530 -a default</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        obj.connect(alias, host, port)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        click.echo(message=e, err=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        click.echo(<span class="string">&quot;Connect Milvus successfully!&quot;</span>)</span><br><span class="line">        click.echo(obj.showConnection(alias))</span><br></pre></td></tr></table></figure>

<p>The first block inside of the function is the help message which will be printed after we input <code>cli connect --help</code>.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">milvus_cli &gt; connect --help</span><br><span class="line">Usage: milvus_cli.py connect [OPTIONS]</span><br><span class="line"></span><br><span class="line">  Connect to Milvus.</span><br><span class="line"></span><br><span class="line">  Example:</span><br><span class="line"></span><br><span class="line">      milvus_cli &gt; connect -h 127.0.0.1 -p 19530 -a default</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -a, --alias TEXT    Milvus link alias name, default is `default`.</span><br><span class="line">  -h, --host TEXT     Host name, default is `127.0.0.1`.</span><br><span class="line">  -p, --port INTEGER  Port, default is `19530`.</span><br><span class="line">  --help              Show this message and exit.</span><br></pre></td></tr></table></figure>

<h3 id="Add-confirm"><a href="#Add-confirm" class="headerlink" title="Add confirm"></a>Add confirm</h3><p>Sometimes we need user to confirm some action especially delete something. We can add <code>click.confirm</code> to pause and ask user to confirm:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@deleteSth.command(<span class="params"><span class="string">&#x27;collection&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;--collection&#x27;</span>, <span class="string">&#x27;collectionName&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;The name of collection to be deleted.&#x27;</span>, default=<span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;-t&#x27;</span>, <span class="string">&#x27;--timeout&#x27;</span>, <span class="string">&#x27;timeout&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;An optional duration of time in seconds to allow for the RPC. If timeout is set to None, the client keeps waiting until the server responds or an error occurs.&#x27;</span>, default=<span class="literal">None</span>, <span class="built_in">type</span>=<span class="built_in">int</span></span>)</span></span><br><span class="line"><span class="meta">@click.pass_obj</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deleteCollection</span>(<span class="params">obj, collectionName, timeout</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Drops the collection together with its index files.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        milvus_cli &gt; delete collection -c car</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    click.echo(</span><br><span class="line">        <span class="string">&quot;Warning!\nYou are trying to delete the collection with data. This action cannot be undone!\n&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> click.confirm(<span class="string">&#x27;Do you want to continue?&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>As the example above, a confirm conversation will show like <code>Aborted!ant to continue? [y/N]:</code>.</p>
<h3 id="Add-prompts"><a href="#Add-prompts" class="headerlink" title="Add prompts"></a>Add prompts</h3><p>To implement prompts we juest need to add <code>click.prompt</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@cli.command()</span></span><br><span class="line"><span class="meta">@click.pass_obj</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query</span>(<span class="params">obj</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Query with a set of criteria, and results in a list of records that match the query exactly.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    collectionName = click.prompt(</span><br><span class="line">        <span class="string">&#x27;Collection name&#x27;</span>, <span class="built_in">type</span>=click.Choice(obj._list_collection_names()))</span><br><span class="line">    expr = click.prompt(<span class="string">&#x27;The query expression(field_name in [x,y])&#x27;</span>)</span><br><span class="line">    partitionNames = click.prompt(</span><br><span class="line">        <span class="string">f&#x27;The names of partitions to search(split by &quot;,&quot; if multiple) <span class="subst">&#123;obj._list_partition_names(collectionName)&#125;</span>&#x27;</span>, default=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    outputFields = click.prompt(</span><br><span class="line">        <span class="string">f&#x27;Fields to return(split by &quot;,&quot; if multiple) <span class="subst">&#123;obj._list_field_names(collectionName)&#125;</span>&#x27;</span>, default=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    timeout = click.prompt(<span class="string">&#x27;timeout&#x27;</span>, default=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>The prompt will show when each <code>click.prompt</code>. We use a few prompts in series so that it’ll look like a continuously conversation. This ensure user will input the data in order we want. In this case we need user to choose a collection first, and we need to get all partitions under this collections, then show them to user to choose.</p>
<h3 id="Add-choices"><a href="#Add-choices" class="headerlink" title="Add choices"></a>Add choices</h3><p>Sometimes you want user just input the limited range/type of value, you can add <code>type=click.Choice([&lt;any&gt;])</code> to <code>click.prompt</code> , <code>click.options</code> and etc..</p>
<p>Such as,</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">collectionName = click.prompt(</span><br><span class="line">        <span class="string">&#x27;Collection name&#x27;</span>, <span class="built_in">type</span>=click.Choice([<span class="string">&#x27;collection_1&#x27;</span>, <span class="string">&#x27;collection_2&#x27;</span>]))</span><br></pre></td></tr></table></figure>

<p>Then user can only input <code>collection_1</code> or <code>collection_2</code> , error will be raised if any other inputs.</p>
<h3 id="Add-clear-screen"><a href="#Add-clear-screen" class="headerlink" title="Add clear screen"></a>Add clear screen</h3><p>You can use <code>click.clear()</code> to implement it.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@cli.command()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clear</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Clear screen.&quot;&quot;&quot;</span></span><br><span class="line">    click.clear()</span><br></pre></td></tr></table></figure>

<h3 id="Additional-tips"><a href="#Additional-tips" class="headerlink" title="Additional tips"></a>Additional tips</h3><ul>
<li>Default value is <code>None</code>, so it’s meaningless if you specified the default value as <code>None</code>. And default <code>None</code> will cause <code>click.prompt</code> continously show if you want to leave a value empty to jump over it.</li>
</ul>
<h2 id="Implement-prompt-CLI-for-user-to-input"><a href="#Implement-prompt-CLI-for-user-to-input" class="headerlink" title="Implement prompt CLI for user to input"></a>Implement prompt CLI for user to input</h2><h3 id="Why-prompt-CLI"><a href="#Why-prompt-CLI" class="headerlink" title="Why prompt CLI"></a>Why prompt CLI</h3><p>For database operation, we need a continuously connection to a instance. If we use origin command line mode, the connection will be dropped after each command performed. We also want to store some data when using CLI, and clean them after exit.</p>
<h3 id="Implement"><a href="#Implement" class="headerlink" title="Implement"></a>Implement</h3><ol>
<li>Use <code>while True</code> for continuously listening user’s input.</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runCliPrompt</span>():</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        astr = <span class="built_in">input</span>(<span class="string">&#x27;milvus_cli &gt; &#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cli(astr.split())</span><br><span class="line">        <span class="keyword">except</span> SystemExit:</span><br><span class="line">            <span class="comment"># trap argparse error message</span></span><br><span class="line">            <span class="comment"># print(&#x27;error&#x27;, SystemExit)</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    runCliPrompt()</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Use <code>input</code> only will cause <code>up</code>, <code>down</code>, <code>left</code>, <code>right</code> arrow keys, <code>tab</code> key and some other keys converted to Acsii string automatically. Besides history commands can not be read from session. So we add <code>readline</code> into <code>runCliPrompt</code> function.</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runCliPrompt</span>():</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    		<span class="keyword">import</span> readline</span><br><span class="line">        readline.set_completer_delims(<span class="string">&#x27; \t\n;&#x27;</span>)</span><br><span class="line">        astr = <span class="built_in">input</span>(<span class="string">&#x27;milvus_cli &gt; &#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cli(astr.split())</span><br><span class="line">        <span class="keyword">except</span> SystemExit:</span><br><span class="line">            <span class="comment"># trap argparse error message</span></span><br><span class="line">            <span class="comment"># print(&#x27;error&#x27;, SystemExit)</span></span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Add <code>quit</code> CLI.</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@cli.command(<span class="params"><span class="string">&#x27;exit&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quitapp</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Exit the CLI.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">global</span> quitapp</span><br><span class="line">    quitapp = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">quitapp = <span class="literal">False</span>  <span class="comment"># global flag</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runCliPrompt</span>():</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> quitapp:</span><br><span class="line">    		<span class="keyword">import</span> readline</span><br><span class="line">        readline.set_completer_delims(<span class="string">&#x27; \t\n;&#x27;</span>)</span><br><span class="line">        astr = <span class="built_in">input</span>(<span class="string">&#x27;milvus_cli &gt; &#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cli(astr.split())</span><br><span class="line">        <span class="keyword">except</span> SystemExit:</span><br><span class="line">            <span class="comment"># trap argparse error message</span></span><br><span class="line">            <span class="comment"># print(&#x27;error&#x27;, SystemExit)</span></span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Catch <code>KeyboardInterrupt</code> error when use <code>ctrl C</code> to exit.</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runCliPrompt</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> quitapp:</span><br><span class="line">            <span class="keyword">import</span> readline</span><br><span class="line">            readline.set_completer_delims(<span class="string">&#x27; \t\n;&#x27;</span>)</span><br><span class="line">            astr = <span class="built_in">input</span>(<span class="string">&#x27;milvus_cli &gt; &#x27;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                cli(astr.split())</span><br><span class="line">            <span class="keyword">except</span> SystemExit:</span><br><span class="line">                <span class="comment"># trap argparse error message</span></span><br><span class="line">                <span class="comment"># print(&#x27;error&#x27;, SystemExit)</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>After all settled, the CLI now looks like:</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">milvus_cli &gt; </span><br><span class="line">milvus_cli &gt; connect</span><br><span class="line">+-------+-----------+</span><br><span class="line">| Host  | 127.0.0.1 |</span><br><span class="line">| Port  |   19530   |</span><br><span class="line">| Alias |  default  |</span><br><span class="line">+-------+-----------+</span><br><span class="line"></span><br><span class="line">milvus_cli &gt; help</span><br><span class="line">Usage:  [OPTIONS] COMMAND [ARGS]...</span><br><span class="line"></span><br><span class="line">  Milvus CLI</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  clear     Clear screen.</span><br><span class="line">  connect   Connect to Milvus.</span><br><span class="line">  create    Create collection, partition and index.</span><br><span class="line">  delete    Delete specified collection, partition and index.</span><br><span class="line">  describe  Describe collection or partition.</span><br><span class="line">  exit      Exit the CLI.</span><br><span class="line">  help      Show help messages.</span><br><span class="line">  import    Import data from csv file with headers and insert into target...</span><br><span class="line">  list      List collections, partitions and indexes.</span><br><span class="line">  load      Load specified collection.</span><br><span class="line">  query     Query with a set of criteria, and results in a list of...</span><br><span class="line">  release   Release specified collection.</span><br><span class="line">  search    Conducts a vector similarity search with an optional boolean...</span><br><span class="line">  show      Show connection, loading_progress and index_progress.</span><br><span class="line">  version   Get Milvus CLI version.</span><br><span class="line"></span><br><span class="line">milvus_cli &gt; exit</span><br></pre></td></tr></table></figure>

<h2 id="Manually-implement-autocomplete"><a href="#Manually-implement-autocomplete" class="headerlink" title="Manually implement autocomplete"></a>Manually implement autocomplete</h2><p>Different from click’s shell autocomplete, our project wrap the command line and use a loop to get user’s input to implement a prompt command line. So we need to bind a completer to <code>readline</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Completer</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    RE_SPACE = re.<span class="built_in">compile</span>(<span class="string">&#x27;.*\s+$&#x27;</span>, re.M)</span><br><span class="line">    CMDS_DICT = &#123;</span><br><span class="line">        <span class="string">&#x27;clear&#x27;</span>: [],</span><br><span class="line">        <span class="string">&#x27;connect&#x27;</span>: [],</span><br><span class="line">        <span class="string">&#x27;create&#x27;</span>: [<span class="string">&#x27;collection&#x27;</span>, <span class="string">&#x27;partition&#x27;</span>, <span class="string">&#x27;index&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;delete&#x27;</span>: [<span class="string">&#x27;collection&#x27;</span>, <span class="string">&#x27;partition&#x27;</span>, <span class="string">&#x27;index&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;describe&#x27;</span>: [<span class="string">&#x27;collection&#x27;</span>, <span class="string">&#x27;partition&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;exit&#x27;</span>: [],</span><br><span class="line">        <span class="string">&#x27;help&#x27;</span>: [],</span><br><span class="line">        <span class="string">&#x27;import&#x27;</span>: [],</span><br><span class="line">        <span class="string">&#x27;list&#x27;</span>: [<span class="string">&#x27;collections&#x27;</span>, <span class="string">&#x27;partitions&#x27;</span>, <span class="string">&#x27;indexes&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;load&#x27;</span>: [],</span><br><span class="line">        <span class="string">&#x27;query&#x27;</span>: [],</span><br><span class="line">        <span class="string">&#x27;release&#x27;</span>: [],</span><br><span class="line">        <span class="string">&#x27;search&#x27;</span>: [],</span><br><span class="line">        <span class="string">&#x27;show&#x27;</span>: [<span class="string">&#x27;connection&#x27;</span>, <span class="string">&#x27;index_progress&#x27;</span>, <span class="string">&#x27;loading_progress&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;version&#x27;</span>: [],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.COMMANDS = <span class="built_in">list</span>(self.CMDS_DICT.keys())</span><br><span class="line">        self.createCompleteFuncs(self.CMDS_DICT)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createCompleteFuncs</span>(<span class="params">self, cmdDict</span>):</span></span><br><span class="line">        <span class="keyword">for</span> cmd <span class="keyword">in</span> cmdDict:</span><br><span class="line">            sub_cmds = cmdDict[cmd]</span><br><span class="line">            complete_example = self.makeComplete(cmd, sub_cmds)</span><br><span class="line">            <span class="built_in">setattr</span>(self, <span class="string">&#x27;complete_%s&#x27;</span> % cmd, complete_example)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">makeComplete</span>(<span class="params">self, cmd, sub_cmds</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">f_complete</span>(<span class="params">args</span>):</span></span><br><span class="line">            <span class="string">f&quot;Completions for the <span class="subst">&#123;cmd&#125;</span> command.&quot;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> args:</span><br><span class="line">                <span class="keyword">return</span> self._complete_path(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt;= <span class="number">1</span> <span class="keyword">and</span> <span class="keyword">not</span> cmd == <span class="string">&#x27;import&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span> self._complete_2nd_level(sub_cmds, args[-<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">return</span> self._complete_path(args[-<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">return</span> f_complete</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_listdir</span>(<span class="params">self, root</span>):</span></span><br><span class="line">        <span class="string">&quot;List directory &#x27;root&#x27; appending the path separator to subdirs.&quot;</span></span><br><span class="line">        res = []</span><br><span class="line">        <span class="keyword">for</span> name <span class="keyword">in</span> os.listdir(root):</span><br><span class="line">            path = os.path.join(root, name)</span><br><span class="line">            <span class="keyword">if</span> os.path.isdir(path):</span><br><span class="line">                name += os.sep</span><br><span class="line">            res.append(name)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_complete_path</span>(<span class="params">self, path=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="string">&quot;Perform completion of filesystem path.&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> path:</span><br><span class="line">            <span class="keyword">return</span> self._listdir(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">        dirname, rest = os.path.split(path)</span><br><span class="line">        tmp = dirname <span class="keyword">if</span> dirname <span class="keyword">else</span> <span class="string">&#x27;.&#x27;</span></span><br><span class="line">        res = [os.path.join(dirname, p)</span><br><span class="line">               <span class="keyword">for</span> p <span class="keyword">in</span> self._listdir(tmp) <span class="keyword">if</span> p.startswith(rest)]</span><br><span class="line">        <span class="comment"># more than one match, or single match which does not exist (typo)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(res) &gt; <span class="number">1</span> <span class="keyword">or</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line">        <span class="comment"># resolved to a single directory, so return list of files below it</span></span><br><span class="line">        <span class="keyword">if</span> os.path.isdir(path):</span><br><span class="line">            <span class="keyword">return</span> [os.path.join(path, p) <span class="keyword">for</span> p <span class="keyword">in</span> self._listdir(path)]</span><br><span class="line">        <span class="comment"># exact file match terminates this completion</span></span><br><span class="line">        <span class="keyword">return</span> [path + <span class="string">&#x27; &#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_complete_2nd_level</span>(<span class="params">self, SUB_COMMANDS=[], cmd=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cmd:</span><br><span class="line">            <span class="keyword">return</span> [c + <span class="string">&#x27; &#x27;</span> <span class="keyword">for</span> c <span class="keyword">in</span> SUB_COMMANDS]</span><br><span class="line">        res = [c <span class="keyword">for</span> c <span class="keyword">in</span> SUB_COMMANDS <span class="keyword">if</span> c.startswith(cmd)]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(res) &gt; <span class="number">1</span> <span class="keyword">or</span> <span class="keyword">not</span> (cmd <span class="keyword">in</span> SUB_COMMANDS):</span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line">        <span class="keyword">return</span> [cmd + <span class="string">&#x27; &#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">complete</span>(<span class="params">self, text, state</span>):</span></span><br><span class="line">        <span class="string">&quot;Generic readline completion entry point.&quot;</span></span><br><span class="line">        buffer = readline.get_line_buffer()</span><br><span class="line">        line = readline.get_line_buffer().split()</span><br><span class="line">        <span class="comment"># show all commands</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> line:</span><br><span class="line">            <span class="keyword">return</span> [c + <span class="string">&#x27; &#x27;</span> <span class="keyword">for</span> c <span class="keyword">in</span> self.COMMANDS][state]</span><br><span class="line">        <span class="comment"># account for last argument ending in a space</span></span><br><span class="line">        <span class="keyword">if</span> self.RE_SPACE.match(buffer):</span><br><span class="line">            line.append(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="comment"># resolve command to the implementation function</span></span><br><span class="line">        cmd = line[<span class="number">0</span>].strip()</span><br><span class="line">        <span class="keyword">if</span> cmd <span class="keyword">in</span> self.COMMANDS:</span><br><span class="line">            impl = <span class="built_in">getattr</span>(self, <span class="string">&#x27;complete_%s&#x27;</span> % cmd)</span><br><span class="line">            args = line[<span class="number">1</span>:]</span><br><span class="line">            <span class="keyword">if</span> args:</span><br><span class="line">                <span class="keyword">return</span> (impl(args) + [<span class="literal">None</span>])[state]</span><br><span class="line">            <span class="keyword">return</span> [cmd + <span class="string">&#x27; &#x27;</span>][state]</span><br><span class="line">        results = [</span><br><span class="line">            c + <span class="string">&#x27; &#x27;</span> <span class="keyword">for</span> c <span class="keyword">in</span> self.COMMANDS <span class="keyword">if</span> c.startswith(cmd)] + [<span class="literal">None</span>]</span><br><span class="line">        <span class="keyword">return</span> results[state]</span><br></pre></td></tr></table></figure>

<p>After define <code>Completer</code> we can bind it with readline:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">comp = Completer()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runCliPrompt</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> quitapp:</span><br><span class="line">            <span class="keyword">import</span> readline</span><br><span class="line">            readline.set_completer_delims(<span class="string">&#x27; \t\n;&#x27;</span>)</span><br><span class="line">            readline.parse_and_bind(<span class="string">&quot;tab: complete&quot;</span>)</span><br><span class="line">            readline.set_completer(comp.complete)</span><br><span class="line">            astr = <span class="built_in">input</span>(<span class="string">&#x27;milvus_cli &gt; &#x27;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                cli(astr.split())</span><br><span class="line">            <span class="keyword">except</span> SystemExit:</span><br><span class="line">                <span class="comment"># trap argparse error message</span></span><br><span class="line">                <span class="comment"># print(&#x27;error&#x27;, SystemExit)</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Add-one-time-option"><a href="#Add-one-time-option" class="headerlink" title="Add one-time option"></a>Add one-time option</h2><p>For prompt command line, sometimes we don’t want to fully run into the scripts to get some informations such as version. A good example is <code>Python</code>, when you type <code>python</code> in terminal the promtp command line will show, but it only returns a version message and will not entry the prompt scripts if you type <code>python -V</code>. So we can use <code>sys.args</code> in our code to implement.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runCliPrompt</span>():</span></span><br><span class="line">    args = sys.argv</span><br><span class="line">    <span class="keyword">if</span> args <span class="keyword">and</span> (args[-<span class="number">1</span>] == <span class="string">&#x27;--version&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Milvus Cli v<span class="subst">&#123;getPackageVersion()&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> quitapp:</span><br><span class="line">            <span class="keyword">import</span> readline</span><br><span class="line">            readline.set_completer_delims(<span class="string">&#x27; \t\n;&#x27;</span>)</span><br><span class="line">            readline.parse_and_bind(<span class="string">&quot;tab: complete&quot;</span>)</span><br><span class="line">            readline.set_completer(comp.complete)</span><br><span class="line">            astr = <span class="built_in">input</span>(<span class="string">&#x27;milvus_cli &gt; &#x27;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                cli(astr.split())</span><br><span class="line">            <span class="keyword">except</span> SystemExit:</span><br><span class="line">                <span class="comment"># trap argparse error message</span></span><br><span class="line">                <span class="comment"># print(&#x27;error&#x27;, SystemExit)</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    runCliPrompt()</span><br></pre></td></tr></table></figure>

<p>We get <code>sys.args</code> before the loop when first run into CLI scripts. If the last arguments is <code>--version</code> , the code will return the package version without running into loop.</p>
<p>It will be helpful after we build the codes as a package. User can type <code>milvus_cli</code> to jump into a prompt CLI, or type <code>milvus_cli --version</code> to only get the version.</p>
<h2 id="Build-and-release"><a href="#Build-and-release" class="headerlink" title="Build and release"></a>Build and release</h2><p>Finally we want to build a package and release by PYPI. So that user can simply use <code>pip install &lt;package name&gt;</code> to install.</p>
<h3 id="Install-locally-for-test"><a href="#Install-locally-for-test" class="headerlink" title="Install locally for test"></a>Install locally for test</h3><p>Before you publish the package to PYPI, you may want to install it locally for some tests.</p>
<p>In this case, you can simply <code>cd</code> into the package directory and run <code>pip install -e .</code> (Don’t forget the <code>.</code>).</p>
<h3 id="Create-package-files"><a href="#Create-package-files" class="headerlink" title="Create package files"></a>Create package files</h3><p>Refer to: <a target="_blank" rel="noopener" href="https://packaging.python.org/tutorials/packaging-projects/">https://packaging.python.org/tutorials/packaging-projects/</a></p>
<p>A package’s structure should look like:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package_example/</span><br><span class="line">├── LICENSE</span><br><span class="line">├── README.md</span><br><span class="line">├── setup.py</span><br><span class="line">├── src/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── main.py</span><br><span class="line">│   └── scripts/</span><br><span class="line">│       ├── __init__.py</span><br><span class="line">│       └── example.py</span><br><span class="line">└── tests/</span><br></pre></td></tr></table></figure>

<h4 id="Create-the-package-directory"><a href="#Create-the-package-directory" class="headerlink" title="Create the package directory"></a>Create the package directory</h4><p>Create <code>Milvus_cli</code> directory with the structure below:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Milvus_cli/</span><br><span class="line">├── LICENSE</span><br><span class="line">├── README.md</span><br><span class="line">├── setup.py</span><br><span class="line">├── milvus_cli/</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── main.py</span><br><span class="line">│   ├── utils.py</span><br><span class="line">│   └── scripts/</span><br><span class="line">│       ├── __init__.py</span><br><span class="line">│       └── milvus_cli.py</span><br><span class="line">└── dist/</span><br></pre></td></tr></table></figure>

<h4 id="Write-the-entry-code"><a href="#Write-the-entry-code" class="headerlink" title="Write the entry code"></a>Write the entry code</h4><p>The script’s entry should be in <code>Milvus_cli/milvus_cli/scripts</code>, and the <code>Milvus_cli/milvus_cli/scripts/milvus_cli.py</code> should be like:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> click</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> PyOrm, Completer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pass_context = click.make_pass_decorator(PyOrm, ensure=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@click.group(<span class="params">no_args_is_help=<span class="literal">False</span>, add_help_option=<span class="literal">False</span>, invoke_without_command=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="meta">@click.pass_context</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cli</span>(<span class="params">ctx</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Milvus CLI&quot;&quot;&quot;</span></span><br><span class="line">    ctx.obj = PyOrm()</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">Here your code.</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@cli.command(<span class="params"><span class="string">&#x27;exit&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quitapp</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Exit the CLI.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">global</span> quitapp</span><br><span class="line">    quitapp = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">quitapp = <span class="literal">False</span>  <span class="comment"># global flag</span></span><br><span class="line">comp = Completer()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runCliPrompt</span>():</span></span><br><span class="line">    args = sys.argv</span><br><span class="line">    <span class="keyword">if</span> args <span class="keyword">and</span> (args[-<span class="number">1</span>] == <span class="string">&#x27;--version&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Milvus Cli v<span class="subst">&#123;getPackageVersion()&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> quitapp:</span><br><span class="line">            <span class="keyword">import</span> readline</span><br><span class="line">            readline.set_completer_delims(<span class="string">&#x27; \t\n;&#x27;</span>)</span><br><span class="line">            readline.parse_and_bind(<span class="string">&quot;tab: complete&quot;</span>)</span><br><span class="line">            readline.set_completer(comp.complete)</span><br><span class="line">            astr = <span class="built_in">input</span>(<span class="string">&#x27;milvus_cli &gt; &#x27;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                cli(astr.split())</span><br><span class="line">            <span class="keyword">except</span> SystemExit:</span><br><span class="line">                <span class="comment"># trap argparse error message</span></span><br><span class="line">                <span class="comment"># print(&#x27;error&#x27;, SystemExit)</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                click.echo(</span><br><span class="line">                    message=<span class="string">f&quot;Error occurred!\n<span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>, err=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    runCliPrompt()</span><br></pre></td></tr></table></figure>

<h4 id="Edit-the-setup-py"><a href="#Edit-the-setup-py" class="headerlink" title="Edit the setup.py"></a>Edit the <code>setup.py</code></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> setuptools <span class="keyword">import</span> setup, find_packages</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;README.md&quot;</span>, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> fh:</span><br><span class="line">    long_description = fh.read()</span><br><span class="line"></span><br><span class="line">setup(</span><br><span class="line">    name=<span class="string">&#x27;milvus_cli&#x27;</span>,</span><br><span class="line">    version=<span class="string">&#x27;0.1.6beta2&#x27;</span>,</span><br><span class="line">    author=<span class="string">&#x27;Milvus Team&#x27;</span>,</span><br><span class="line">    author_email=<span class="string">&#x27;milvus-team@zilliz.com&#x27;</span>,</span><br><span class="line">    url=<span class="string">&#x27;https://github.com/milvus-io/milvus_cli&#x27;</span>,</span><br><span class="line">    description=<span class="string">&#x27;CLI for Milvus&#x27;</span>,</span><br><span class="line">    long_description=long_description,</span><br><span class="line">    long_description_content_type=<span class="string">&#x27;text/markdown&#x27;</span>,</span><br><span class="line">    license=<span class="string">&#x27;Apache-2.0&#x27;</span>,</span><br><span class="line">    packages=find_packages(),</span><br><span class="line">    include_package_data=<span class="literal">True</span>,</span><br><span class="line">    install_requires=[</span><br><span class="line">        <span class="string">&#x27;Click==8.0.1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;pymilvus==2.0.0rc5&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tabulate==0.8.9&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">    entry_points=&#123;</span><br><span class="line">        <span class="string">&#x27;console_scripts&#x27;</span>: [</span><br><span class="line">            <span class="string">&#x27;milvus_cli = milvus_cli.scripts.milvus_cli:runCliPrompt&#x27;</span>,</span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line">    python_requires=<span class="string">&#x27;&gt;=3.8&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>Some tips here:</p>
<ol>
<li>We use <code>README.md</code> content as the package’s long description.</li>
<li>Add all dependencies to <code>install_requires</code>.</li>
<li>Specify the <code>entry_points</code>. In this case,  we set <code>milvus_cli</code> as a child of  <code>console_scripts</code>, so that we can type <code>milvus_cli</code> as a command directly after we install this package. And the <code>milvus_cli</code>‘s entry point is <code>runCliPrompt</code> function in <code>milvus_cli/scripts/milvus_cli.py</code>.</li>
</ol>
<h4 id="Build"><a href="#Build" class="headerlink" title="Build"></a>Build</h4><ol>
<li><p>Upgrade the <code>build</code> package: <code>python3 -m pip install --upgrade build</code></p>
</li>
<li><p>Run build: <code>python -m build --sdist --wheel --outdir dist/ .</code></p>
</li>
<li><p>Two files will be generated under the <code>dist/</code> directory:</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dist/</span><br><span class="line">  example_package_YOUR_USERNAME_HERE-0.0.1-py3-none-any.whl</span><br><span class="line">  example_package_YOUR_USERNAME_HERE-0.0.1.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="Publish-release"><a href="#Publish-release" class="headerlink" title="Publish release"></a>Publish release</h3><p>Refer to: <a target="_blank" rel="noopener" href="https://packaging.python.org/tutorials/packaging-projects/#uploading-the-distribution-archives">https://packaging.python.org/tutorials/packaging-projects/#uploading-the-distribution-archives</a></p>
<ol>
<li>Upgrade <code>twine</code> package: <code>python3 -m pip install --upgrade twine</code></li>
<li>Upload to <code>PYPI</code> test env: <code>python3 -m twine upload --repository testpypi dist/*</code></li>
<li>Upload to <code>PYPI</code> : <code>python3 -m twine upload dist/*</code></li>
</ol>
<h3 id="CI-CD-by-Github-workflows"><a href="#CI-CD-by-Github-workflows" class="headerlink" title="CI/CD by Github workflows"></a>CI/CD by Github workflows</h3><p>Refer to: <a target="_blank" rel="noopener" href="https://packaging.python.org/guides/publishing-package-distribution-releases-using-github-actions-ci-cd-workflows/">https://packaging.python.org/guides/publishing-package-distribution-releases-using-github-actions-ci-cd-workflows/</a></p>
<p>We want a way to upload assets automatically, it can build the packages and upload them to github releases and PYPI.</p>
<p>(For some reason we just want the workflow only publish the release to test PYPI.)</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is a basic workflow to help you get started with Actions</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">Update</span> <span class="string">the</span> <span class="string">release&#x27;s</span> <span class="string">assets</span> <span class="string">after</span> <span class="string">it</span> <span class="string">published</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Controls when the workflow will run</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">release:</span></span><br><span class="line">    <span class="comment"># The workflow will run after release published</span></span><br><span class="line">    <span class="attr">types:</span> [<span class="string">published</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># A workflow run is made up of one or more jobs that can run sequentially or in parallel</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="comment"># This workflow contains a single job called &quot;build&quot;</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="comment"># The type of runner that the job will run on</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Steps represent a sequence of tasks that will be executed as part of the job</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="comment"># Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/setup-python@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">python-version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line">          <span class="attr">architecture:</span> <span class="string">&#x27;x64&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">pypa/build</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">&gt;-</span></span><br><span class="line"><span class="string">          python -m</span></span><br><span class="line"><span class="string">          pip install</span></span><br><span class="line"><span class="string">          build</span></span><br><span class="line"><span class="string">          --user</span></span><br><span class="line"><span class="string"></span>      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Clean</span> <span class="string">dist/</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          sudo rm -fr dist/*</span></span><br><span class="line"><span class="string"></span>      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">a</span> <span class="string">binary</span> <span class="string">wheel</span> <span class="string">and</span> <span class="string">a</span> <span class="string">source</span> <span class="string">tarball</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">&gt;-</span></span><br><span class="line"><span class="string">          python -m</span></span><br><span class="line"><span class="string">          build</span></span><br><span class="line"><span class="string">          --sdist</span></span><br><span class="line"><span class="string">          --wheel</span></span><br><span class="line"><span class="string">          --outdir dist/</span></span><br><span class="line"><span class="string">          .</span></span><br><span class="line"><span class="string"></span>      <span class="comment"># Update target github release&#x27;s assets </span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Update</span> <span class="string">assets</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">softprops/action-gh-release@v1</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">startsWith(github.ref,</span> <span class="string">&#x27;refs/tags/&#x27;</span><span class="string">)</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">files:</span> <span class="string">./dist/*</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Publish</span> <span class="string">distribution</span> <span class="string">📦</span> <span class="string">to</span> <span class="string">Test</span> <span class="string">PyPI</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">contains(github.ref,</span> <span class="string">&#x27;beta&#x27;</span><span class="string">)</span> <span class="string">&amp;&amp;</span> <span class="string">startsWith(github.ref,</span> <span class="string">&#x27;refs/tags&#x27;</span><span class="string">)</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">pypa/gh-action-pypi-publish@release/v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">user:</span> <span class="string">__token__</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.TEST_PYPI_API_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">repository_url:</span> <span class="string">https://test.pypi.org/legacy/</span></span><br><span class="line">          <span class="attr">packages_dir:</span> <span class="string">dist/</span></span><br><span class="line">          <span class="attr">verify_metadata:</span> <span class="literal">false</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">czhen</p>
  <div class="site-description" itemprop="description">Tech Sharing</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">3</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">czhen</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
